<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Hello World!</title>
  <script src="../node_modules/cesium/Build/Cesium/Cesium.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.4.0.min.js"> </script>

  <!-- <script src="/cesium_maps.js"></script>
  
  <script src="/one_year.js"></script>
  <script src="/two_year.js"></script>
  <script src="/hotspot.js"></script>
 <script src="/main.js"></script> 
  <script src = "/dat.gui.min.js"> </script> -->
  <script src = "/satellite.min.js"> </script> 
  <script src="/Catalogue.js"></script>
  <script src = "/dat.gui.min.js"> </script> 
  <script src = "/KeplerianElement.js"> </script> 

<style>
    @import url(../node_modules/cesium/Build/Cesium/Widgets/widgets.css);
     html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
          /* This here will allow the cesium container to fill the rest of the page */
          display: flex; flex-direction: column; 
      }
           /* .toolbar-left {
            display: block;
            position: absolute;
            top: 5px;
            left: 5px;
        }  */
        /* Turn on when a slider is needed */
        /* #slider {
            position: absolute;
            height: 100%;
            left: 50%;
            top: 0px;
            background-color: #D3D3D3;
            width: 4px;
            z-index: -1;
        }
        #slider:hover {
            cursor: ew-resize;
        } */
        .navbar {
          z-index: -1;
        }

        #gui { position: absolute; top: 100px; }
</style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Future Space Population</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item active col-md-auto">
          <a class="nav-link" href="#" onclick="oneYearLoad();">View 1 Year <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item col-md-auto">
          <a class="nav-link" href="#" onclick="twoYear();">Compare 2 Years</a>
        </li>
        <li class="nav-item col-md-auto">
          <a class="nav-link" href="#" onclick="hotspotData();">Hotspot Analysis</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li> -->
        <input type="text" class="form-control" placeholder="View a Single Year" aria-label="year" aria-describedby="basic-addon1">
      </ul>
    </div>
  </nav>

  <div id="cesiumContainer">
    <div id="slider"></div>
  </div>

    <script>
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjODcyZDRmZC03ZmUzLTQwNTktOTM4Mi1jMmI0OWIwODY2NDkiLCJpZCI6NTcwMTcsImlhdCI6MTYyMTk2ODM2NH0.lzeb9LrtQ6y3uotDuKUN3djp1kz-4o5BMq5c8uIe_tU';
    
// author: Zhen Li
// email: hpulizhen@163.com

// Grant CesiumJS access to your ion assets

// Z. Li's Cesium ion access token
// Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNmJiODMwMi1mODRiLTQ2YTEtODMzZC0zYTVlY2Q5YmQxMjMiLCJpZCI6OTkxMSwic2NvcGVzIjpbImFzciIsImdjIl0sImlhdCI6MTU1NTI4Mzg1NH0.gvjcqfwCYVBcmZ11Jzr-k5Q13QXZ6qGVer9WSXOs9K8';
// Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNmJiODMwMi1mODRiLTQ2YTEtODMzZC0zYTVlY2Q5YmQxMjMiLCJpZCI6OTkxMSwic2NvcGVzIjpbImFzciIsImdjIl0sImlhdCI6MTU1NTI4Mzg1NH0.gvjcqfwCYVBcmZ11Jzr-k5Q13QXZ6qGVer9WSXOs9K8';

var viewer_main, radar_viewer;
var start_jd;

var clockViewModel; /// the clockmodel for synchronisation of two views
var data_load=false;
var debris_collection;
var debri_collection_radar; /// it is the same as debris_collection

var satcat;
var data_path="data/";


var options3D = {
  homeButton : false,
  fullscreenButton : false,
  sceneModePicker : false,
  clockViewModel : clockViewModel,
  infoBox : false,
  geocoder : false,
  sceneMode : Cesium.SceneMode.SCENE3D,
  navigationHelpButton : false,
  animation : false,
  CreditDisplay : false,
  timeline: false,
  baseLayerPicker : false
};

var options2D = {
  homeButton : false,
  fullscreenButton : false,
  sceneModePicker : true,
  clockViewModel : clockViewModel,
  infoBox : true,
  geocoder : false,
  sceneMode : Cesium.SceneMode.SCENE2D,
  navigationHelpButton : false,
  animation : false,
  CreditDisplay : false,
  timeline: false,
  baseLayerPicker : false
};


function icrf_view_main(scene, time) 
{
  if (scene.mode !== Cesium.SceneMode.SCENE3D) 
  {
      return;
  }
  var icrfToFixed = Cesium.Transforms.computeIcrfToFixedMatrix(time);
  if (Cesium.defined(icrfToFixed)) 
  {
      var camera = viewer_main.camera;
      var offset = Cesium.Cartesian3.clone(camera.position);
      var transform = Cesium.Matrix4.fromRotationTranslation(icrfToFixed);
      camera.lookAtTransform(transform, offset);
  }
}


function ecef2blh(x_ecef,y_ecef,z_ecef)
{
  //var ellipsoid_wgs84 = Cesium.Ellipsoid.WGS84;
	var FE_WGS84 = (1.0/298.257223563);
	var	RE_WGS84 = 6378137.0;
	var	PI = Math.PI;
	var e2=FE_WGS84*(2.0-FE_WGS84);
	var	r2=x_ecef*x_ecef + y_ecef*y_ecef,z,zk,v=RE_WGS84,sinp;
	for(z=z_ecef,zk=0.0;Math.abs(z-zk)>=1E-4;)
	{
		zk=z;
		sinp=z/Math.sqrt(r2+z*z);
		v=RE_WGS84/Math.sqrt(1.0-e2*sinp*sinp);
		z=z_ecef+v*e2*sinp;
  }
  var blh = new Array();
	blh[0]=r2>1E-12?Math.atan(z/Math.sqrt(r2)):(z_ecef>0.0?Math.PI/2.0:-Math.PI/2.0);
	blh[1]=r2>1E-12?Math.atan2(y_ecef,x_ecef):0.0;
  blh[2]=Math.sqrt(r2+z*z)-v;
  return blh;
	}



function xyz2enu_matrix(lat,lon)
{
    var E = new Array(9);
    var sinp=Math.sin(lat),cosp=Math.cos(lat),sinl=Math.sin(lon),cosl=Math.cos(lon);
    E[0]=-sinl;      E[1]=cosl;       E[2]=0.0;
    E[3]=-sinp*cosl; E[4]=-sinp*sinl; E[5]=cosp;
    E[6]=cosp*cosl;  E[7]=cosp*sinl;  E[8]=sinp;
    return E;
}


//function update_debris_position(debris_set, viewer,mycatlog)
function update_debris_position() // this seems to be the proble,
{
    var debris_set = debris_collection;
    var viewer = viewer_main;
    var mycatlog = satcat;

    time = viewer.clock.currentTime; /// the current computer time in TAI? not in UTC?
    var tai_utc = Cesium.JulianDate.computeTaiMinusUtc(time); /// Time is in localtime ???
    
    var time_utc = Cesium.JulianDate.now();
    Cesium.JulianDate.addSeconds(time, tai_utc, time_utc); // often modified julian date, as it is a smaller number 6 digits before dp

    // var t1_now = Cesium.JulianDate.now();
    // var t2_now = Date.now();

    var icrfToFixed = Cesium.Transforms.computeIcrfToFixedMatrix(time_utc);
    var time_date_js = Cesium.JulianDate.toDate(time_utc); /// convert time into js Date()
    
    
    var position_ecef = new Cesium.Cartesian3();
    var points = debris_set._pointPrimitives;
    var length = points.length;

    // if (length > 0)
    // {
    //   console.log("point number in debris_set._pointPrimitives is loaded!");
    // }

    var pos_radar_view = new Cesium.Cartesian3();

    for (var i = 0; i < length; ++i) 
    {
      var point = points[i];
      //Cesium.Cartesian3.clone(point.position, position_ecef);
      ///compute the position of debris according to time
      if (Cesium.defined(icrfToFixed)) // date transformation
      {
        var positionAndVelocity = mycatlog.compute_debri_position_eci(i, time_date_js);//  satellite.propagate(tle_rec,time_date);
        
        var position_eci = new Cesium.Cartesian3(positionAndVelocity.position.x*1000,positionAndVelocity.position.y*1000,positionAndVelocity.position.z*1000);
        
        position_ecef = Cesium.Matrix3.multiplyByVector(icrfToFixed, position_eci, position_ecef);
        
        Cesium.Cartesian3.clone(position_ecef,pos_radar_view);

        point.position = position_ecef; //// update back
        

  //       ///update the radar_view
  //       //debri_collection_radar._pointPrimitives[i].position = pos_radar_view;

      }
  }
}



 var cataloglist =
{
  cat_1 : "fspcat_test",  /// the catalogue file for test
  cat_2 : "fspcat_20190522_v04_nodeb", //// baseline_fspcat_20190522_v04_nodeb.json
	cat_3 : "fspcat_20280101_v04_nodeb", /// fspcat_20280101_v04_nodeb.json
	cat_4 : "fspcat_20230101", /// fspcat_20230101.json
  cat_5 : "fspcat_20230701", /// fspcat_20230701.json
  cat_6 : "fspcat_20230101_v16_nodeb", 
  cat_7 : "fspcat_20280101_v230819_nodeb", 
  cat_8 : "fspcat_20430701_v16_nodeb", 
  cat_9 : "fspcat_20430701_sk_nodeb", 
  cat_10 : "fspcat_20430701_v270819_nodeb", 
  cat_11 : "fspcat_baseline_20190522_v280819_nodeb", 
  cat_12 : "fspcat_20230101_v280819_nodeb", 
  cat_13 : "fspcat_20280101_v280819_nodeb", 
  cat_14 : "fspcat_20430701_v280819_nodeb", 
  cat_15: "2019",
  tle_1 : "tle_test",
	tle_2 : "tle_geo"  /// geo_tle.json	
}

function GUIset()
{
  var gui = new dat.GUI( { width: 300} );
  // gui.domElement.id = 'datgui';

	var folderSpacecraft = gui.addFolder( 'Catalogue option' );
  var aaa={catalogName: ""}; ///cataloglist.cat_1
	folderSpacecraft.add( aaa, 'catalogName', Object.values(cataloglist) ).onChange(
		function( value )
		{
      // alert(value);
      ///first clear all the catalog data
      satcat.clear_catalog();
      data_load = false;
      debris_collection.removeAll();
      debri_collection_radar.removeAll();

      var satcat_logfile="";
      var type="";
      if(value.substring(0,6) == "fspcat")
      {
        type="kep";
        satcat_logfile = data_path + "catalogue/" + value  + ".json";
      }
      else if(value.substring(0,3) == "tle")
      {
        type="tle";
        satcat_logfile = data_path + "tle/" + value  + ".json";
      }
      else if(value.substring(0,4) == "2019") {
        type="test";
        satcat_logfile="http://satellite-api.herokuapp.com/test/test";
      }

      satcat.loadcatlog(type,satcat_logfile);
      ///load the corresponding catalog files
      // console.log("successfully loaded data");
		}
  );
    
  
  
}


// window.onload = function()
// {
  
  satcat = new Catalogue();

  GUIset();

  clockViewModel = new Cesium.ClockViewModel();

  // viewer_main = new Cesium.Viewer('main_viewer',{
  //   //   imageryProvider : Cesium.createTileMapServiceImageryProvider({
  //   //     url : Cesium.buildModuleUrl('../Cesium/Assets/Textures/NaturalEarthII')
  //   // }),
  //   baseLayerPicker : false,
  //   geocoder : false,
  //   timeline: true,
  //   clockViewModel : clockViewModel
  //   });

  var viewer_main = new Cesium.Viewer('cesiumContainer', {
    //Use Cesium World Terrain
    terrainProvider : Cesium.createWorldTerrain()
});
    
    //Enable depth testing so things behind the terrain disappear.
    viewer_main.scene.globe.depthTestAgainstTerrain = true;

		
		viewer_main.globe = true;
		viewer_main.scene.globe.enableLighting = true;
    viewer_main.clock.multiplier =  100 ;               // speed of the simulation
    
    var mycredit= new Cesium.Credit("Space Geodesy and Navigation Laboratory",'data/sgnl.png','https://www.ucl.ac.uk');
    // var mycredit = new Cesium.Credit('Cesium', 'data/sgnl.png', 'https://www.ucl.ac.uk');
    viewer_main.scene.frameState.creditDisplay.addDefaultCredit(mycredit);
    viewer_main.CreditDisplay = true;
    viewer_main.scene.debugShowFramesPerSecond = true;
    viewer_main.scene.frameState.creditDisplay.removeDefaultCredit();

    start_jd = Cesium.JulianDate.now();
    //start_jd = Cesium.JulianDate.fromIso8601("2019-01-01T13:00:00Z");
    viewer_main.clock.startTime = Cesium.JulianDate.now(); ///It is in system loal time
    viewer_main.clock.clockRange = Cesium.ClockRange.UNBOUNDED;
    viewer_main.timeline.zoomTo(start_jd, Cesium.JulianDate.addSeconds(start_jd, 86400, new Cesium.JulianDate()));

    

  
    // var satcat_log = "data/catalogue/fspcat_20230101.json";
    // var tle_log = "data/tle/geo_tle.json";

    // satcat.loadcatlog("kep",satcat_log);
    // satcat.loadcatlog("tle",tle_log);
    
    /// debris_collection to store all the debris points
    debris_collection = new Cesium.PointPrimitiveCollection();
    debri_collection_radar = new Cesium.PointPrimitiveCollection();
    //By seting the blendOption to OPAQUE can improve the performance twice
    debri_collection_radar.blendOption = Cesium.BlendOption.OPAQUE;

    /// add debris_collection to the viewer_main
    /// should organize debris in different orbtis to different collections
    debris_collection = viewer_main.scene.primitives.add(debris_collection);
    debris_collection.blendOption=Cesium.BlendOption.OPAQUE;

    var colour = Cesium.Color.YELLOW;
    
    /// a timer is used to deal with the async reading of JSON
    var timename=setInterval(function(){
      if(satcat.data_load_complete == true
        && data_load == false)
        {
          //ShowDebris(viewer_main,mycatlog,4);
          console.log(satcat.getNumberTotal());
          for (var debrisID = 0; debrisID < satcat.getNumberTotal(); debrisID++) 
          {

            var operation_status = satcat.getDebriOperation_status(debrisID);
            if (operation_status > 0.0) 
            {
              colour = Cesium.Color.YELLOW;
            }
            else
            {
              colour = Cesium.Color.RED;
            }

            //console.log(satcat.getDebriName([debrisID])); // undefined
            //console.log(debrisID);
            debris_collection.add({
            id: satcat.getDebriName([debrisID]),
            position: Cesium.Cartesian3.fromDegrees(0.0, 0.0),
            pixelSize: 3,
            color: colour
            // scaleByDistance : new Cesium.NearFarScalar(100.0, 4.0, 6.0E4, 0.8)
              });  

          }

          data_load=true;
          // clearInterval(timename); /// clear itself
        }
    },1000); /// allow sometime to load the Earth 

  
    viewer_main.scene.postUpdate.addEventListener(icrf_view_main); // enable Earth rotation, everything is seen to be in eci
    viewer_main.scene.preRender.addEventListener(update_debris_position);
    ///viewer_main.scene.preRender.raiseEvent(debris_collection, viewer_main,mycatlog);



//}







  
 
 

  </script>
</body>
</html>